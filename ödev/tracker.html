<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üì± Tracker Pro v3.0</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f0f1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tracker Pro">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 16px;
            padding-bottom: 100px;
        }

        .container { max-width: 500px; margin: 0 auto; }

        .header { text-align: center; padding: 24px 0; }

        .logo {
            width: 70px; height: 70px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border-radius: 18px;
            margin: 0 auto 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 32px rgba(0, 217, 255, 0.3);
        }

        h1 { font-size: 1.5rem; margin-bottom: 4px; }
        .subtitle { color: #8892b0; font-size: 0.9rem; }
        .version { 
            display: inline-block;
            background: linear-gradient(135deg, #00ff88, #00d9ff);
            color: #0f0f1a;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #00ff88;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-box { text-align: center; padding: 16px; }

        .status-icon {
            width: 90px; height: 90px;
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px;
            transition: all 0.5s;
            position: relative;
        }

        .status-icon.off {
            background: rgba(255,255,255,0.05);
            border: 3px solid #444;
        }

        .status-icon.on {
            background: rgba(0, 255, 136, 0.15);
            border: 3px solid #00ff88;
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.4);
            animation: pulse 2s infinite;
        }

        .status-icon.reconnecting {
            background: rgba(255, 200, 0, 0.15);
            border: 3px solid #ffc800;
            animation: pulse 1s infinite;
        }

        .status-icon .ring {
            position: absolute;
            width: 100%; height: 100%;
            border: 2px solid #00ff88;
            border-radius: 50%;
            animation: ring 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 40px rgba(0, 255, 136, 0.4); }
            50% { box-shadow: 0 0 60px rgba(0, 255, 136, 0.6); }
        }

        @keyframes ring {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .status-text { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
        .status-detail { color: #8892b0; font-size: 0.85rem; }

        /* Baƒülantƒ± Durumu Badge */
        .connection-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-top: 10px;
        }

        .connection-badge.online {
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
        }

        .connection-badge.offline {
            background: rgba(255, 77, 77, 0.15);
            color: #ff4d4d;
        }

        .connection-badge.reconnecting {
            background: rgba(255, 200, 0, 0.15);
            color: #ffc800;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connection-badge::before {
            content: '';
            width: 8px; height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        label {
            display: block; color: #8892b0;
            font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 8px;
        }

        input {
            width: 100%; padding: 14px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff; font-size: 1.1rem;
            text-align: center; letter-spacing: 3px;
            text-transform: uppercase;
        }

        input:focus { outline: none; border-color: #00ff88; }

        .hint { color: #555; font-size: 0.75rem; margin-top: 8px; text-align: center; }

        .btn {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            gap: 10px; margin-top: 12px;
            transition: all 0.3s;
        }

        .btn-start {
            background: linear-gradient(135deg, #00ff88, #00d9ff);
            color: #0f0f1a;
        }

        .btn-start:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0, 255, 136, 0.3); }

        .btn-stop {
            background: rgba(255, 77, 77, 0.15);
            border: 2px solid #ff4d4d;
            color: #ff4d4d;
        }

        .hidden { display: none !important; }

        .video-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            margin-bottom: 12px;
        }

        .video-preview {
            width: 100%;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 8px; left: 8px;
            display: flex; gap: 6px;
        }

        .video-badge {
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            display: flex; align-items: center; gap: 4px;
        }

        .video-badge.live { background: rgba(255, 77, 77, 0.8); }
        .video-badge.live::before {
            content: '';
            width: 6px; height: 6px;
            background: #fff;
            border-radius: 50%;
            animation: liveBlink 1s infinite;
        }

        @keyframes liveBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-grid.three-cols {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .info-item {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .info-item.highlight {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .info-label {
            font-size: 0.65rem; color: #666;
            text-transform: uppercase; margin-bottom: 4px;
        }

        .info-value {
            font-size: 0.9rem; color: #00ff88;
            font-family: monospace;
            font-weight: 600;
        }

        .info-value.large {
            font-size: 1.3rem;
        }

        .code-display {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 217, 255, 0.1));
            border: 2px dashed rgba(0, 255, 136, 0.5);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 12px;
        }

        .code-display p { color: #8892b0; margin-bottom: 6px; font-size: 0.85rem; }
        .code-display .code {
            font-size: 1.8rem; font-weight: 700;
            background: linear-gradient(135deg, #00ff88, #00d9ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 5px;
            font-family: monospace;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 10px 6px;
            text-align: center;
            font-size: 0.65rem;
            transition: all 0.3s;
        }

        .feature-item.active {
            background: rgba(0, 255, 136, 0.15);
            border-color: rgba(0, 255, 136, 0.5);
        }

        .feature-item span {
            display: block;
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Ses Seviyesi G√∂stergesi */
        .audio-meter {
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .audio-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #ffff00, #ff4d4d);
            border-radius: 4px;
            transition: width 0.1s;
            width: 0%;
        }

        .audio-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
        }

        /* Hareket G√∂stergesi */
        .motion-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .motion-indicator.still {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
        }

        .motion-indicator.moving {
            background: rgba(255, 200, 0, 0.1);
            color: #ffc800;
            animation: motionPulse 1s infinite;
        }

        @keyframes motionPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Cihaz Bilgileri */
        .device-info {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .device-tag {
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            color: #8892b0;
        }

        /* Log B√∂l√ºm√º */
        .log-container {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.7rem;
        }

        .log-item {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            gap: 8px;
        }

        .log-time { color: #666; }
        .log-msg { color: #00ff88; }
        .log-msg.error { color: #ff4d4d; }
        .log-msg.warning { color: #ffc800; }
        .log-msg.info { color: #00d9ff; }

        /* Keep Alive Indicator */
        .keep-alive-bar {
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .keep-alive-progress {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d9ff);
            width: 100%;
            animation: keepAlive 30s linear infinite;
        }

        @keyframes keepAlive {
            0% { width: 100%; }
            100% { width: 0%; }
        }

        /* PWA Install Banner */
        .pwa-banner {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #0f0f1a;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pwa-banner.hidden { display: none; }

        .pwa-banner p { font-size: 0.85rem; font-weight: 500; }

        .pwa-banner button {
            background: rgba(0,0,0,0.2);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: #0f0f1a;
            font-weight: 600;
            cursor: pointer;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .stat-mini {
            text-align: center;
        }

        .stat-mini .value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #00ff88;
        }

        .stat-mini .label {
            font-size: 0.65rem;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üì±</div>
            <h1>Tracker Pro</h1>
            <p class="subtitle">Kesintisiz Takip Sistemi</p>
            <span class="version">v3.0 - Auto Reconnect</span>
        </div>

        <!-- PWA Install Banner -->
        <div class="pwa-banner hidden" id="pwaBanner">
            <p>üì≤ Ana ekrana ekle - Arka planda √ßalƒ±≈üƒ±r!</p>
            <button id="installBtn">Y√ºkle</button>
        </div>

        <!-- Durum -->
        <div class="card">
            <div class="status-box">
                <div class="status-icon off" id="statusIcon">
                    <div class="ring" style="display: none;" id="statusRing"></div>
                    üì°
                </div>
                <div class="status-text" id="statusText">Baƒülantƒ± Kapalƒ±</div>
                <div class="status-detail" id="statusDetail">Ba≈ülatmak i√ßin kod girin</div>
                
                <div class="connection-badge offline" id="connectionBadge">
                    <span id="connectionText">√áevrimdƒ±≈üƒ±</span>
                </div>
            </div>
        </div>

        <!-- Kurulum -->
        <div class="card" id="setupCard">
            <div class="card-title">üîó Baƒülantƒ± Ayarlarƒ±</div>
            <label>Baƒülantƒ± Kodu (min. 6 karakter)</label>
            <input type="text" id="codeInput" placeholder="√∂rn: abc123" maxlength="12">
            <p class="hint">Bu kodu bilgisayardaki kontrol paneline gireceksiniz</p>

            <button class="btn btn-start" id="startBtn">
                üöÄ Baƒülantƒ±yƒ± Ba≈ülat
            </button>

            <div class="features-grid" style="margin-top: 16px;">
                <div class="feature-item" id="featCam">
                    <span>üì∑</span>
                    Kamera
                </div>
                <div class="feature-item" id="featMic">
                    <span>üé§</span>
                    Mikrofon
                </div>
                <div class="feature-item" id="featLoc">
                    <span>üìç</span>
                    Konum
                </div>
                <div class="feature-item" id="featAuto">
                    <span>üîÑ</span>
                    Oto Baƒülan
                </div>
            </div>
        </div>

        <!-- Aktif Durum -->
        <div class="card hidden" id="activeCard">
            <div class="code-display">
                <p>Bilgisayara bu kodu girin:</p>
                <div class="code" id="displayCode">------</div>
            </div>

            <!-- Kamera -->
            <div class="video-container">
                <video id="videoPreview" class="video-preview" autoplay muted playsinline></video>
                <div class="video-overlay">
                    <div class="video-badge live">CANLI</div>
                    <div class="video-badge" id="cameraType">Arka Kamera</div>
                </div>
            </div>

            <!-- Ses Seviyesi -->
            <div class="card-title">üé§ Ses Seviyesi</div>
            <div class="audio-meter">
                <div class="audio-meter-fill" id="audioMeter"></div>
            </div>
            <div class="audio-info">
                <span>Sessiz</span>
                <span id="audioLevel">0 dB</span>
                <span>Y√ºksek</span>
            </div>

            <!-- Keep Alive Bar -->
            <div class="keep-alive-bar">
                <div class="keep-alive-progress" id="keepAliveBar"></div>
            </div>

            <!-- ƒ∞statistikler -->
            <div class="stats-row">
                <div class="stat-mini">
                    <div class="value" id="uptimeVal">0</div>
                    <div class="label">Dakika</div>
                </div>
                <div class="stat-mini">
                    <div class="value" id="reconnectVal">0</div>
                    <div class="label">Yeniden Baƒü.</div>
                </div>
                <div class="stat-mini">
                    <div class="value" id="dataVal">0</div>
                    <div class="label">KB G√∂nderildi</div>
                </div>
            </div>
        </div>

        <!-- Konum Bilgileri -->
        <div class="card hidden" id="locationCard">
            <div class="card-title">üìç Konum Bilgileri</div>
            <div class="info-grid">
                <div class="info-item highlight">
                    <div class="info-label">Enlem</div>
                    <div class="info-value" id="latVal">--</div>
                </div>
                <div class="info-item highlight">
                    <div class="info-label">Boylam</div>
                    <div class="info-value" id="lngVal">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Hassasiyet</div>
                    <div class="info-value" id="accVal">-- m</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Rakƒ±m</div>
                    <div class="info-value" id="altVal">-- m</div>
                </div>
            </div>

            <div class="info-grid three-cols" style="margin-top: 10px;">
                <div class="info-item">
                    <div class="info-label">Hƒ±z</div>
                    <div class="info-value large" id="speedVal">0</div>
                    <div class="info-label">km/s</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Mesafe</div>
                    <div class="info-value large" id="distanceVal">0</div>
                    <div class="info-label">metre</div>
                </div>
                <div class="info-item">
                    <div class="info-label">G√ºncelleme</div>
                    <div class="info-value" id="updateCount">0</div>
                    <div class="info-label">adet</div>
                </div>
            </div>

            <div class="motion-indicator still" id="motionIndicator">
                <span>üßç</span> Duraƒüan
            </div>
        </div>

        <!-- Cihaz & Pil -->
        <div class="card hidden" id="deviceCard">
            <div class="card-title">üìä Cihaz Durumu</div>
            <div class="info-grid">
                <div class="info-item highlight">
                    <div class="info-label">Pil</div>
                    <div class="info-value large" id="batVal">--%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Son G√ºncelleme</div>
                    <div class="info-value" id="timeVal">--:--:--</div>
                </div>
            </div>
            <div class="device-info" id="deviceInfo"></div>
        </div>

        <!-- Log -->
        <div class="card hidden" id="logCard">
            <div class="card-title">üìã ƒ∞≈ülem G√ºnl√ºƒü√º</div>
            <div class="log-container" id="logContainer"></div>
        </div>

        <!-- Durdur Butonu -->
        <div class="hidden" id="stopSection">
            <button class="btn btn-stop" id="stopBtn">
                ‚èπÔ∏è Baƒülantƒ±yƒ± Durdur
            </button>
            <p class="hint" style="margin-top: 10px;">
                ‚ö†Ô∏è Sayfayƒ± kapatabilirsiniz - Sistem arka planda √ßalƒ±≈ümaya devam eder
            </p>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDR9gR5nhJ2Y2nNLBKwK7IiAr1_KVWjHSw",
            authDomain: "gizli-38804.firebaseapp.com",
            databaseURL: "https://gizli-38804-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gizli-38804",
            storageBucket: "gizli-38804.firebasestorage.app",
            messagingSenderId: "653791348128",
            appId: "1:653791348128:web:ac6502b2692441b99610c5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        class PersistentTracker {
            constructor() {
                this.code = '';
                this.videoStream = null;
                this.mediaRecorder = null;
                this.audioContext = null;
                this.analyser = null;
                this.watchId = null;
                this.isActive = false;
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                // ƒ∞statistikler
                this.stats = {
                    updateCount: 0,
                    totalDistance: 0,
                    lastPosition: null,
                    startTime: null,
                    isMoving: false,
                    reconnectCount: 0,
                    dataSent: 0
                };

                // Auto reconnect
                this.isOnline = navigator.onLine;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 100; // √áok fazla deneme
                this.reconnectDelay = 3000; // 3 saniye
                this.keepAliveInterval = null;
                this.uptimeInterval = null;

                this.init();
            }

            init() {
                // Kaydedilmi≈ü kod varsa y√ºkle
                const saved = localStorage.getItem('tracker_code_v3');
                if (saved) document.getElementById('codeInput').value = saved;

                // Auto-start if was running
                const wasRunning = localStorage.getItem('tracker_running') === 'true';
                const savedCode = localStorage.getItem('tracker_code_v3');
                
                if (wasRunning && savedCode) {
                    document.getElementById('codeInput').value = savedCode;
                    this.log('√ñnceki oturum tespit edildi, otomatik ba≈ülatƒ±lƒ±yor...', 'info');
                    setTimeout(() => this.start(), 1000);
                }

                // Event listeners
                document.getElementById('startBtn').addEventListener('click', () => this.start());
                document.getElementById('stopBtn').addEventListener('click', () => this.stop());

                // Network status listeners
                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());

                // Visibility change - sayfa g√∂r√ºn√ºr olunca reconnect
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && this.isActive) {
                        this.log('Sayfa tekrar g√∂r√ºn√ºr, baƒülantƒ± kontrol ediliyor...', 'info');
                        this.checkAndReconnect();
                    }
                });

                // Sayfa kapatƒ±lƒ±rken
                window.addEventListener('beforeunload', () => {
                    // Durumu kaydet ama tamamen kapatma
                    if (this.isActive) {
                        localStorage.setItem('tracker_running', 'true');
                    }
                });

                // Page show (geri tu≈üu ile d√∂nd√ºƒü√ºnde)
                window.addEventListener('pageshow', (event) => {
                    if (event.persisted && this.isActive) {
                        this.log('Sayfa cache\'den y√ºklendi, yeniden baƒülanƒ±lƒ±yor...', 'info');
                        this.checkAndReconnect();
                    }
                });

                this.detectDevice();
                this.setupPWA();
            }

            setupPWA() {
                let deferredPrompt;
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    document.getElementById('pwaBanner').classList.remove('hidden');
                });

                document.getElementById('installBtn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            this.log('PWA y√ºklendi!', 'success');
                        }
                        deferredPrompt = null;
                        document.getElementById('pwaBanner').classList.add('hidden');
                    }
                });

                // Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(() => {
                        // SW yoksa sorun yok
                    });
                }
            }

            handleOnline() {
                this.isOnline = true;
                this.updateConnectionBadge('online');
                this.log('ƒ∞nternet baƒülantƒ±sƒ± geri geldi!', 'success');
                
                if (this.isActive) {
                    this.checkAndReconnect();
                }
            }

            handleOffline() {
                this.isOnline = false;
                this.updateConnectionBadge('offline');
                this.log('ƒ∞nternet baƒülantƒ±sƒ± kesildi!', 'error');
            }

            updateConnectionBadge(status) {
                const badge = document.getElementById('connectionBadge');
                const text = document.getElementById('connectionText');
                
                badge.className = 'connection-badge ' + status;
                
                switch(status) {
                    case 'online':
                        text.textContent = 'Baƒülƒ±';
                        break;
                    case 'offline':
                        text.textContent = '√áevrimdƒ±≈üƒ±';
                        break;
                    case 'reconnecting':
                        text.textContent = 'Yeniden Baƒülanƒ±yor...';
                        break;
                }
            }

            async checkAndReconnect() {
                if (!this.isOnline) {
                    this.log('ƒ∞nternet yok, bekleniyor...', 'warning');
                    return;
                }

                this.updateConnectionBadge('reconnecting');
                this.stats.reconnectCount++;
                document.getElementById('reconnectVal').textContent = this.stats.reconnectCount;

                try {
                    // Firebase baƒülantƒ±sƒ±nƒ± test et
                    await db.ref('devices/' + this.code + '/status').set('online');
                    
                    this.updateConnectionBadge('online');
                    this.log('Yeniden baƒülandƒ±! (#' + this.stats.reconnectCount + ')', 'success');
                    
                    // Medya stream'leri kontrol et
                    if (!this.videoStream || !this.videoStream.active) {
                        this.log('Kamera/mikrofon yeniden ba≈ülatƒ±lƒ±yor...', 'info');
                        await this.restartMedia();
                    }
                    
                    // Konum izleme kontrol et
                    if (!this.watchId) {
                        this.startLocationWatch();
                    }
                    
                    this.reconnectAttempts = 0;
                    
                } catch (error) {
                    this.log('Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
                    this.scheduleReconnect();
                }
            }

            scheduleReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    this.log('Maksimum deneme sayƒ±sƒ±na ula≈üƒ±ldƒ±', 'error');
                    return;
                }

                this.reconnectAttempts++;
                const delay = Math.min(this.reconnectDelay * this.reconnectAttempts, 30000);
                
                this.log(`${delay/1000}s sonra tekrar denenecek (${this.reconnectAttempts}/${this.maxReconnectAttempts})`, 'warning');
                
                setTimeout(() => {
                    if (this.isActive && this.isOnline) {
                        this.checkAndReconnect();
                    }
                }, delay);
            }

            async restartMedia() {
                // Eski stream'i kapat
                if (this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                }

                try {
                    this.videoStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                        audio: true
                    });
                    
                    document.getElementById('videoPreview').srcObject = this.videoStream;
                    this.setupAudioAnalyser();
                    this.startAudioRecording();
                    
                    this.log('Kamera ve mikrofon yeniden ba≈ülatƒ±ldƒ±', 'success');
                } catch (e) {
                    this.log('Medya ba≈ülatƒ±lamadƒ±: ' + e.message, 'error');
                }
            }

            detectDevice() {
                const info = [];
                const ua = navigator.userAgent;
                
                if (/Android/i.test(ua)) info.push('Android');
                else if (/iPhone|iPad|iPod/i.test(ua)) info.push('iOS');
                else info.push('Diƒüer');
                
                if (/Chrome/i.test(ua)) info.push('Chrome');
                else if (/Safari/i.test(ua)) info.push('Safari');
                else if (/Firefox/i.test(ua)) info.push('Firefox');
                
                info.push(`${screen.width}x${screen.height}`);
                
                if (navigator.connection) {
                    info.push(navigator.connection.effectiveType || 'Bilinmiyor');
                }

                document.getElementById('deviceInfo').innerHTML = info.map(i => `<span class="device-tag">${i}</span>`).join('');
            }

            log(msg, type = 'info') {
                const container = document.getElementById('logContainer');
                const time = new Date().toLocaleTimeString('tr-TR');
                const item = document.createElement('div');
                item.className = 'log-item';
                item.innerHTML = `<span class="log-time">[${time}]</span><span class="log-msg ${type}">${msg}</span>`;
                container.insertBefore(item, container.firstChild);
                
                while (container.children.length > 50) {
                    container.removeChild(container.lastChild);
                }
            }

            async start() {
                this.code = document.getElementById('codeInput').value.trim().toLowerCase();
                
                if (!this.code || this.code.length < 6) {
                    alert('L√ºtfen en az 6 karakterlik bir kod girin.');
                    return;
                }

                localStorage.setItem('tracker_code_v3', this.code);
                localStorage.setItem('tracker_running', 'true');
                
                this.log('Baƒülantƒ± ba≈ülatƒ±lƒ±yor...');
                document.getElementById('featAuto').classList.add('active');

                try {
                    // Kamera + Mikrofon
                    this.log('Kamera ve mikrofon izni isteniyor...');
                    this.videoStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                        audio: true
                    });
                    
                    document.getElementById('videoPreview').srcObject = this.videoStream;
                    document.getElementById('featCam').classList.add('active');
                    document.getElementById('featMic').classList.add('active');
                    this.log('‚úì Kamera ve mikrofon aktif');

                    this.setupAudioAnalyser();

                    // Konum izni
                    this.log('Konum izni isteniyor...');
                    await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000
                        });
                    });
                    document.getElementById('featLoc').classList.add('active');
                    this.log('‚úì Konum eri≈üimi aktif');

                    // Hareket sens√∂r√º
                    if (window.DeviceMotionEvent) {
                        window.addEventListener('devicemotion', (e) => this.handleMotion(e));
                        this.log('‚úì Hareket sens√∂r√º aktif');
                    }

                    // Ba≈üarƒ±lƒ±
                    this.isActive = true;
                    this.stats.startTime = Date.now();
                    this.updateUI(true);
                    this.updateConnectionBadge('online');
                    
                    this.startTracking();
                    this.startAudioRecording();
                    this.startKeepAlive();
                    this.startUptimeCounter();
                    
                    this.log('‚úì T√ºm servisler ba≈ülatƒ±ldƒ±', 'success');

                    // Wake lock - ekranƒ± a√ßƒ±k tut
                    this.requestWakeLock();

                } catch (error) {
                    console.error('ƒ∞zin hatasƒ±:', error);
                    this.log('‚úó Hata: ' + error.message, 'error');
                    alert('ƒ∞zin hatasƒ±: ' + error.message);
                    localStorage.setItem('tracker_running', 'false');
                }
            }

            async requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        await navigator.wakeLock.request('screen');
                        this.log('Ekran kilidi aktif - Ekran kapanmayacak', 'info');
                    } catch (e) {
                        this.log('Wake lock desteklenmiyor', 'warning');
                    }
                }
            }

            startKeepAlive() {
                // Her 25 saniyede Firebase'e ping at
                this.keepAliveInterval = setInterval(() => {
                    if (this.isActive && this.isOnline) {
                        db.ref('devices/' + this.code + '/heartbeat').set({
                            timestamp: Date.now(),
                            uptime: Math.floor((Date.now() - this.stats.startTime) / 1000)
                        }).catch(() => {
                            this.log('Heartbeat g√∂nderilemedi', 'warning');
                            this.checkAndReconnect();
                        });
                    }
                }, 25000);
            }

            startUptimeCounter() {
                this.uptimeInterval = setInterval(() => {
                    if (this.stats.startTime) {
                        const minutes = Math.floor((Date.now() - this.stats.startTime) / 60000);
                        document.getElementById('uptimeVal').textContent = minutes;
                    }
                }, 10000);
            }

            setupAudioAnalyser() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(this.videoStream);
                    source.connect(this.analyser);
                    this.analyser.fftSize = 256;
                    
                    const updateMeter = () => {
                        if (!this.isActive) return;
                        
                        const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(dataArray);
                        
                        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                        const percent = Math.min(100, (average / 128) * 100);
                        
                        document.getElementById('audioMeter').style.width = percent + '%';
                        document.getElementById('audioLevel').textContent = Math.round(average) + ' dB';
                        
                        if (this.isOnline) {
                            db.ref('devices/' + this.code + '/audioLevel').set({
                                level: Math.round(percent),
                                timestamp: Date.now()
                            });
                        }
                        
                        requestAnimationFrame(updateMeter);
                    };
                    updateMeter();
                } catch (e) {
                    this.log('Ses analizi ba≈ülatƒ±lamadƒ±', 'warning');
                }
            }

            handleMotion(event) {
                if (!this.isActive) return;
                
                const acc = event.acceleration;
                if (!acc) return;
                
                const magnitude = Math.sqrt((acc.x || 0) ** 2 + (acc.y || 0) ** 2 + (acc.z || 0) ** 2);
                const isMoving = magnitude > 2;
                
                if (isMoving !== this.stats.isMoving) {
                    this.stats.isMoving = isMoving;
                    const indicator = document.getElementById('motionIndicator');
                    
                    if (isMoving) {
                        indicator.className = 'motion-indicator moving';
                        indicator.innerHTML = '<span>üèÉ</span> Hareket Halinde';
                        this.log('Hareket algƒ±landƒ±', 'warning');
                    } else {
                        indicator.className = 'motion-indicator still';
                        indicator.innerHTML = '<span>üßç</span> Duraƒüan';
                    }
                    
                    if (this.isOnline) {
                        db.ref('devices/' + this.code + '/motion').set({
                            isMoving,
                            magnitude: Math.round(magnitude * 100) / 100,
                            timestamp: Date.now()
                        });
                    }
                }
            }

            stop() {
                this.isActive = false;
                localStorage.setItem('tracker_running', 'false');
                this.log('Baƒülantƒ± durduruluyor...');

                if (this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                    this.videoStream = null;
                }

                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }

                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }

                if (this.keepAliveInterval) {
                    clearInterval(this.keepAliveInterval);
                }

                if (this.uptimeInterval) {
                    clearInterval(this.uptimeInterval);
                }

                if (this.code) {
                    db.ref('devices/' + this.code + '/status').set('offline');
                }

                this.log('Baƒülantƒ± kapatƒ±ldƒ±');
                this.updateUI(false);
                this.updateConnectionBadge('offline');
            }

            startTracking() {
                this.startLocationWatch();

                // Kamera g√∂r√ºnt√ºs√º
                this.sendFrame();
                setInterval(() => {
                    if (this.isActive && this.isOnline) this.sendFrame();
                }, 1500);

                this.trackBattery();
            }

            startLocationWatch() {
                this.watchId = navigator.geolocation.watchPosition(
                    (pos) => this.handlePosition(pos),
                    (err) => {
                        this.log('Konum hatasƒ±: ' + err.message, 'error');
                        // Konum hatasƒ± olursa tekrar dene
                        setTimeout(() => {
                            if (this.isActive && !this.watchId) {
                                this.startLocationWatch();
                            }
                        }, 5000);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            }

            handlePosition(position) {
                if (!this.isActive) return;

                const { latitude, longitude, accuracy, speed, altitude, heading } = position.coords;
                const timestamp = Date.now();

                if (this.stats.lastPosition) {
                    const dist = this.calculateDistance(
                        this.stats.lastPosition.lat,
                        this.stats.lastPosition.lng,
                        latitude,
                        longitude
                    );
                    if (dist > 1) {
                        this.stats.totalDistance += dist;
                    }
                }

                this.stats.lastPosition = { lat: latitude, lng: longitude };
                this.stats.updateCount++;

                // UI g√ºncelle
                document.getElementById('latVal').textContent = latitude.toFixed(6);
                document.getElementById('lngVal').textContent = longitude.toFixed(6);
                document.getElementById('accVal').textContent = Math.round(accuracy) + ' m';
                document.getElementById('altVal').textContent = altitude ? Math.round(altitude) + ' m' : '-- m';
                document.getElementById('speedVal').textContent = speed ? Math.round(speed * 3.6) : '0';
                document.getElementById('distanceVal').textContent = Math.round(this.stats.totalDistance);
                document.getElementById('updateCount').textContent = this.stats.updateCount;
                document.getElementById('timeVal').textContent = new Date().toLocaleTimeString('tr-TR');

                if (!this.isOnline) return;

                // Firebase'e g√∂nder
                const data = {
                    lat: latitude,
                    lng: longitude,
                    accuracy: accuracy || 0,
                    speed: speed || 0,
                    altitude: altitude || 0,
                    heading: heading || 0,
                    timestamp,
                    updateCount: this.stats.updateCount,
                    totalDistance: Math.round(this.stats.totalDistance)
                };

                db.ref('devices/' + this.code + '/location').set(data);
                db.ref('devices/' + this.code + '/status').set('online');
                db.ref('devices/' + this.code + '/history').push({ lat: latitude, lng: longitude, timestamp });

                this.stats.dataSent += 0.5;
                document.getElementById('dataVal').textContent = Math.round(this.stats.dataSent);

                if (this.stats.updateCount % 10 === 0) {
                    this.log(`Konum #${this.stats.updateCount} g√∂nderildi`);
                }
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            startAudioRecording() {
                if (!this.videoStream) return;

                const audioTrack = this.videoStream.getAudioTracks()[0];
                if (!audioTrack) return;

                const audioStream = new MediaStream([audioTrack]);

                const recordAndSend = () => {
                    if (!this.isActive) return;

                    const chunks = [];
                    try {
                        this.mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm;codecs=opus' });
                    } catch (e) {
                        this.mediaRecorder = new MediaRecorder(audioStream);
                    }

                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };

                    this.mediaRecorder.onstop = () => {
                        if (chunks.length > 0 && this.isActive && this.isOnline) {
                            const blob = new Blob(chunks, { type: 'audio/webm' });
                            this.sendAudio(blob);
                        }
                        if (this.isActive) setTimeout(recordAndSend, 100);
                    };

                    this.mediaRecorder.start();
                    setTimeout(() => {
                        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                            this.mediaRecorder.stop();
                        }
                    }, 3000);
                };

                recordAndSend();
            }

            async sendAudio(blob) {
                try {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        db.ref('devices/' + this.code + '/audio').set({
                            data: reader.result,
                            timestamp: Date.now()
                        });
                        this.stats.dataSent += blob.size / 1024;
                        document.getElementById('dataVal').textContent = Math.round(this.stats.dataSent);
                    };
                    reader.readAsDataURL(blob);
                } catch (e) {
                    this.log('Ses g√∂nderme hatasƒ±', 'error');
                }
            }

            sendFrame() {
                if (!this.videoStream || !this.isActive || !this.isOnline) return;

                const video = document.getElementById('videoPreview');
                
                this.canvas.width = 640;
                this.canvas.height = 480;
                this.ctx.drawImage(video, 0, 0, 640, 480);

                const imageData = this.canvas.toDataURL('image/jpeg', 0.6);

                db.ref('devices/' + this.code + '/camera').set({
                    image: imageData,
                    timestamp: Date.now(),
                    width: 640,
                    height: 480
                });

                this.stats.dataSent += 30;
                document.getElementById('dataVal').textContent = Math.round(this.stats.dataSent);
            }

            async trackBattery() {
                if ('getBattery' in navigator) {
                    try {
                        const battery = await navigator.getBattery();
                        
                        const update = () => {
                            const level = Math.round(battery.level * 100);
                            const charging = battery.charging;
                            
                            document.getElementById('batVal').textContent = level + '%' + (charging ? ' ‚ö°' : '');
                            
                            if (this.isOnline) {
                                db.ref('devices/' + this.code + '/battery').set({
                                    level,
                                    charging,
                                    timestamp: Date.now()
                                });
                            }
                        };

                        battery.addEventListener('levelchange', update);
                        battery.addEventListener('chargingchange', update);
                        update();
                        setInterval(update, 30000);
                    } catch (e) {
                        this.log('Pil API desteklenmiyor', 'warning');
                    }
                }
            }

            updateUI(active) {
                const statusIcon = document.getElementById('statusIcon');
                const statusRing = document.getElementById('statusRing');
                const statusText = document.getElementById('statusText');
                const statusDetail = document.getElementById('statusDetail');

                if (active) {
                    statusIcon.classList.remove('off');
                    statusIcon.classList.add('on');
                    statusRing.style.display = 'block';
                    statusText.textContent = 'Aktif';
                    statusDetail.textContent = 'Kesintisiz aktarƒ±m';
                    
                    document.getElementById('setupCard').classList.add('hidden');
                    document.getElementById('activeCard').classList.remove('hidden');
                    document.getElementById('locationCard').classList.remove('hidden');
                    document.getElementById('deviceCard').classList.remove('hidden');
                    document.getElementById('logCard').classList.remove('hidden');
                    document.getElementById('stopSection').classList.remove('hidden');
                    document.getElementById('displayCode').textContent = this.code.toUpperCase();
                } else {
                    statusIcon.classList.add('off');
                    statusIcon.classList.remove('on');
                    statusRing.style.display = 'none';
                    statusText.textContent = 'Baƒülantƒ± Kapalƒ±';
                    statusDetail.textContent = 'Ba≈ülatmak i√ßin kod girin';
                    
                    document.getElementById('setupCard').classList.remove('hidden');
                    document.getElementById('activeCard').classList.add('hidden');
                    document.getElementById('locationCard').classList.add('hidden');
                    document.getElementById('deviceCard').classList.add('hidden');
                    document.getElementById('logCard').classList.add('hidden');
                    document.getElementById('stopSection').classList.add('hidden');
                }
            }
        }

        new PersistentTracker();
    </script>
</body>
</html>
